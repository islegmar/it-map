<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
  <script src = "https://d3js.org/d3.v4.min.js"></script>
  <script src="js/PapaParse-4.6.0/papaparse.min.js"></script>
  <script src="csv.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.16/svg.min.js" integrity="sha512-p3Tp2zn+wApBreZCgRkmMwnfpN8MUPXzzOihXx7iGYXqE7t6m9drY8HeyMeeFuDWiTFKrGUrq3jpbT0vX6zY/Q==" crossorigin="anonymous"></script>

  <!-- http://www.draw2d.org/draw2d_touch/jsdoc_6/#!/example/shape -->
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/shifty.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/raphael.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/jquery-1.10.2.min.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/jquery.autoresize.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/jquery-touch_punch.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/jquery.contextmenu.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/rgbcolor.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/canvg.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/Class.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/json2.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/lib/pathfinding-browser.min.js"></SCRIPT>
  <SCRIPT src="http://www.draw2d.org/draw2d_touch/jsdoc_6/draw2d/src/draw2d.js"></SCRIPT>
  <style>
  image {
    z-index:10;
    position:absolute;
  }
  line {
    z-index:1;
    position:absolute;
    fill:#94d31b; 
    stroke-color:#94d31b; 
    stroke-width:2;
  }
  </style>
</head>

<body>
<div>
  <input id="csv" class="csv" type='file' multiple='multiple'></input>
</div>
<!--
<svg id="svg" width="600" height="600"></svg>
-->
<div id="canvas"></div>
</body>

<script>

// Return a search of items based on a condition
function getItems(map, check) {
  var found=[];

  map.forEach(function(item) {
    if ( check(item) ) {
      found.push(item);
    }
  });

  return found;
}

document.addEventListener('DOMContentLoaded', function() {
  $('input#csv').on('change', function(event) {
    eventCSVUpload(
      event, 
      function(item) {
        item['X']=parseInt(item['X']);
        item['Y']=parseInt(item['Y']);
      }, 
      function(data) {
      // Build the map
      var map=[];
      data.forEach(function(item) {
        map.push(item);
      });

      // Draw the map
      var canvas = new draw2d.Canvas("canvas");
      //var svg = d3.select("#canvas").append("svg").attr("width", 800).attr("height", 800);
      //var svg2=document.getElementById('svg');
      var draw = SVG().addTo('#canvas').size(800, 800)

      getItems(map, function(item) {
        return item['parent.id']==null || item['parent.id'].length==0;
      }).forEach(function(item) {
        var rect = draw.image('./img/' + item['Type'] + '.jpeg').attr({ 
          width : 50,
          height : 50,
          x : item['X'], 
          y : item['Y']
        });
        var text = draw.text(item['Name']).attr({ 
          x : item['X'], 
          y : item['Y'] + 50
        });
   
        if ( item['relatedID'] ) {
          getItems(map, function(item2) {
            return item2['Id']==item['relatedID'];
          }).forEach(function(item2) {
            var line = draw.line(item['X']+25, item['Y']+25, item2['X']+25, item2['Y']+25)
              .stroke({ color:'red'})
              .back();
          });
        }
        /*
        var node=new draw2d.shape.node.Start();
        node.add(new draw2d.shape.basic.Label({text:"Test Label"}), new draw2d.layout.locator.TopLocator());
        canvas.add( node,item['X'],item['Y']);

        svg.append('rect')
           .attr('x', item['X'])
           .attr('y', item['Y'])
           .attr('width', 40)
           .attr('height', 40)
           .attr('stroke', 'black')
           .attr('fill', '#69a3b2');
        */
      });
    }, true);
  });
});
</script>
</html>
